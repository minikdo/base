#!/bin/bash

set -ux

UUID='83ba2834-54d4-49ff-b697-71dd6ae8eb58'

play_connect () {
    nmcli --wait 30 con up $1
}

echo -n >/tmp/.myip

# check if Play is connected
nmcli connection show --active | grep "${UUID}" 

# connect
if [ $? != 0 ]; then
    #nmcli radio wwan off                               
    nmcli radio wifi off
    nmcli radio wwan on 
    sleep 3s
    play_connect $UUID
    
else
    # disconnect and delete ssh cache
    nmcli con down $UUID
    nmcli radio wwan off                               
    nmcli radio wifi off
    ssh-add -D
    exit
fi

TRIES=0

# check internet or connect again       
while [ $TRIES -lt 3 ]; do
    ping -w4 -c2 8.8.8.8  > /dev/null 2>&1
                                          
    if [ $? = 0 ]; then                   

	# start nm-applet if died due to seg fault
	pgrep nm-applet || nm-applet &>/dev/null &disown
        break      
    fi           

    nmcli radio wwan off
    nmcli radio wwan on   
    sleep 6s
    play_connect $UUID
    
    TRIES=$(($TRIES+1))
done
